# Copyright Â© 2025 Novasama Technologies GmbH
# SPDX-License-Identifier: Apache-2.0

name: "Upload to S3"
description: "Upload files or directories to S3-compatible storage"

inputs:
  s3_region:
    description: "S3 region"
    required: true
  s3_access_key:
    description: "S3 access key"
    required: true
  s3_secret_key:
    description: "S3 secret key"
    required: true
  s3_bucket:
    description: "S3 bucket (e.g., s3://my-bucket)"
    required: true
  source_path:
    description: "File or directory path to upload"
    required: true
  destination_path:
    description: "Destination path in bucket"
    required: true
  provider:
    description: "S3 provider"
    required: false
    default: "scaleway"
  acl:
    description: "Access control (public or private)"
    required: false
    default: "public"

outputs:
  uploaded_path:
    description: "Full S3 path"
    value: ${{ steps.upload.outputs.path }}

runs:
  using: "composite"
  steps:
    - name: Setup S3cmd
      uses: s3-actions/s3cmd@v2.0.1
      with:
        provider: ${{ inputs.provider }}
        region: ${{ inputs.s3_region }}
        secret_key: ${{ inputs.s3_secret_key }}
        access_key: ${{ inputs.s3_access_key }}

    - name: Upload to S3
      id: upload
      shell: bash
      run: |
        SOURCE="${{ inputs.source_path }}"
        DEST="${{ inputs.s3_bucket }}${{ inputs.destination_path }}"
        ACL="${{ inputs.acl }}"

        if [ -d "$SOURCE" ]; then
          echo "ðŸ“ Uploading directory: $SOURCE"
          s3cmd sync "$SOURCE" "$DEST" --acl-$ACL
        elif [ -f "$SOURCE" ]; then
          echo "ðŸ“„ Uploading file: $SOURCE"
          s3cmd put "$SOURCE" "$DEST" --acl-$ACL
        else
          echo "âŒ Error: $SOURCE not found"
          exit 1
        fi

        echo "path=$DEST" >> $GITHUB_OUTPUT
        echo "âœ… Uploaded to: $DEST"
